<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UML class diagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #333; }
    .page {
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(280px, 1fr);
      gap: 16px;
    }
    .diagram-pane, .source-pane {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: #fafafa;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page.source-collapsed {
      grid-template-columns: minmax(0, 1fr);
    }
    .page.source-collapsed .source-pane {
      display: none;
    }
    .diagram-wrap {
      position: relative;
      flex: 1 1 auto;
      overflow: hidden;
    }
    .diagram-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
      display: flex;
      gap: 6px;
    }
    .diagram-toolbar button {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
    }
    .diagram-wrap .svg-pan-zoom_viewport { cursor: grab; }
    .diagram-wrap .svg-pan-zoom_viewport:active { cursor: grabbing; }
    .diagram-wrap svg { width: 100% !important; height: 100% !important; max-width: none !important; }
    .source-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      background: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 12px;
      color: #5a5a5a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .source-header button {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: none;
    }
    .copy-status {
      font-size: 11px;
      color: #2f7a2f;
      opacity: 0;
      transition: opacity 0.2s ease;
      min-width: 70px;
      text-align: right;
    }
    .copy-status.visible {
      opacity: 1;
    }
    .copy-status.error {
      color: #b00020;
    }
    .source-content {
      flex: 1 1 auto;
      overflow: auto;
      padding: 16px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 12px;
      line-height: 1.5;
      background: #ffffff;
      color: #333;
      white-space: pre;
    }
    pre.mermaid { display: none; }
  </style>
</head>
<body>

<div class="page">
  <pre class="mermaid" id="m1">
${mermaidString}
  </pre>
</div>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

  <script>
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose',
      maxTextSize: 1000000,

      // 1) Ask Mermaid not to force max-width on diagrams
      flowchart: { useMaxWidth: false },
      er:        { useMaxWidth: false },
      sequence:  { useMaxWidth: false },
      class:     { useMaxWidth: false },       // for classDiagram
      classDiagram: { useMaxWidth: false },    // (some versions use this key)

      // extra belt-and-suspenders: CSS injection at render time
      themeCSS: '.mermaid svg{max-width:none !important;height:100% !important;width:100% !important;}'
    });

    const vscode = acquireVsCodeApi();

    (async function () {
      var src = document.getElementById('m1');
      var graphText = src ? src.textContent : '';
      var out = await mermaid.render('m1-svg', graphText);

      var wrap = document.createElement('div');
      wrap.className = 'diagram-wrap';

      var toolbar = document.createElement('div');
      toolbar.className = 'diagram-toolbar';
      toolbar.innerHTML =
        '<button type="button" data-a="zin">+</button>' +
        '<button type="button" data-a="zout">−</button>' +
        '<button type="button" data-a="fit">Fit</button>' +
        '<button type="button" data-a="download">Download SVG</button>' +
        '<button type="button" data-a="toggle-source" aria-expanded="true">Hide code</button>';
      wrap.appendChild(toolbar);

      wrap.insertAdjacentHTML('beforeend', out.svg);
      var page = src.parentNode;
      page.innerHTML = '';

      var diagramPane = document.createElement('div');
      diagramPane.className = 'diagram-pane';
      diagramPane.appendChild(wrap);

      var sourcePane = document.createElement('div');
      sourcePane.className = 'source-pane';
      sourcePane.innerHTML = '<div class="source-header"><span>Mermaid source</span><span class="copy-status" aria-live="polite" role="status"></span><button type="button" class="copy-button">Copy</button></div>';
      var sourceContent = document.createElement('pre');
      sourceContent.className = 'source-content';
      sourceContent.textContent = graphText.trim();
      sourcePane.appendChild(sourceContent);

      page.appendChild(diagramPane);
      page.appendChild(sourcePane);

      function setSourceCollapsed(collapsed) {
        page.classList.toggle('source-collapsed', collapsed);
        sourcePane.classList.toggle('collapsed', collapsed);
        var toggle = toolbar.querySelector('[data-a="toggle-source"]');
        if (toggle) {
          toggle.textContent = collapsed ? 'Show code' : 'Hide code';
          toggle.setAttribute('aria-expanded', (!collapsed).toString());
        }
      }

      setSourceCollapsed(false);

      // 3) Normalize the rendered <svg> just in case
      var svgEl = wrap.querySelector('svg');
      if (svgEl) {
        svgEl.style.maxWidth = 'none';
        svgEl.style.width = '100%';
        svgEl.style.height = '100%';
        // Sometimes Mermaid sets explicit width/height numbers; wipe them
        svgEl.setAttribute('width', '100%');
        svgEl.setAttribute('height', '100%');
      }

      var pz = svgPanZoom(svgEl, {
        zoomEnabled: true,
        panEnabled: true,
        mouseWheelZoomEnabled: true,
        controlIconsEnabled: false,
        fit: true, center: true,
        minZoom: 0.2, maxZoom: 10,
        contain: false,
        preventMouseEventsDefault: true
      });

      pz.enablePan();

      var STEP = 0.2;
      toolbar.addEventListener('click', function (e) {
        var a = e.target && e.target.getAttribute('data-a');
        if (!a) { return; }
        e.preventDefault();
        if (a === 'zin')  pz.zoomBy(1 + STEP);
        if (a === 'zout') pz.zoomBy(1 / (1 + STEP));
        if (a === 'fit')  { pz.resize(); pz.fit(); pz.center(); }
        if (a === 'download') downloadSVG(svgEl, 'diagram.svg');
        if (a === 'toggle-source') setSourceCollapsed(!page.classList.contains('source-collapsed'));
      });

      var copyButton = sourcePane.querySelector('.copy-button');
      if (copyButton) {
        copyButton.addEventListener('click', function () {
          copyTextToClipboard(sourceContent.textContent || '').then(function (success) {
            showCopyFeedback(copyButton, success);
          });
        });
      }

      window.addEventListener('resize', function () {
        pz.resize(); pz.fit(); pz.center();
      }, { passive: true });
    })();



function downloadSVG(svgEl, filename) {
  // Clone so we can tweak without touching the on-page SVG
  var clone = svgEl.cloneNode(true);

  // Undo svg-pan-zoom’s viewport transform so you get the full diagram
  var vp = clone.querySelector('.svg-pan-zoom_viewport');
  if (vp) vp.removeAttribute('transform');

  // Ensure clean sizing (portable in other tools)
  var vb = clone.getAttribute('viewBox');
  if (vb) {
    var p = vb.trim().split(/\s+/);
    var w = parseFloat(p[2]), h = parseFloat(p[3]);
    if (!isNaN(w) && !isNaN(h)) {
      clone.setAttribute('width', w + 'px');
      clone.setAttribute('height', h + 'px');
    }
  }
  clone.style.maxWidth = 'none';
  clone.removeAttribute('style'); // drop width:100%/height:100% if present

  // Ensure namespaces for standalone file
  if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
  if (!clone.getAttribute('xmlns:xlink')) clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');

  // Serialize and hand off to the extension for saving
  var xml = '<?xml version="1.0" encoding="UTF-8"?>\n' + new XMLSerializer().serializeToString(clone);
  vscode.postMessage({ type: 'downloadSvg', filename: filename || 'diagram.svg', svg: xml });
}

function copyTextToClipboard(text) {
  if (!text) { return Promise.resolve(false); }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text).then(function () {
      return true;
    }).catch(function () {
      return legacyCopy(text);
    });
  }
  return Promise.resolve(legacyCopy(text));
}

function legacyCopy(text) {
  var textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.setAttribute('readonly', '');
  textarea.style.position = 'absolute';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  var success = false;
  try {
    success = document.execCommand('copy');
  } catch (err) {
    console.error('Failed to copy text', err);
    success = false;
  }
  document.body.removeChild(textarea);
  return success;
}

function showCopyFeedback(button, success) {
  if (!button) { return; }
  var header = button.closest('.source-header');
  if (!header) { return; }
  var status = header.querySelector('.copy-status');
  if (!status) { return; }

  status.textContent = success ? 'Copied!' : 'Copy failed';
  status.classList.toggle('error', !success);
  status.classList.add('visible');

  if (status._copyTimeout) {
    clearTimeout(status._copyTimeout);
  }
  status._copyTimeout = setTimeout(function () {
    status.classList.remove('visible');
  }, 2000);
}


  </script>
</body>
</html>

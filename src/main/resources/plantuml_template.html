<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PlantUML class diagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o9N1j7kMkQGyy6JyxBqs5hGuB59lB6L1RxCu2LLC5wE=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #333; }
    .page {
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(280px, 1fr);
      gap: 16px;
    }
    .diagram-pane, .source-pane {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: #fafafa;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page.source-collapsed {
      grid-template-columns: minmax(0, 1fr);
    }
    .page.source-collapsed .source-pane {
      display: none;
    }
    .diagram-wrap {
      position: relative;
      flex: 1 1 auto;
      overflow: hidden;
    }
    .diagram-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
      display: flex;
      gap: 6px;
    }
    .diagram-toolbar button,
    .diagram-toolbar a {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    .diagram-scroll {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }
    .diagram-map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    .diagram-map.leaflet-container {
      background: transparent;
    }
    .diagram-map .leaflet-control-container {
      display: none;
    }
    .diagram-map .diagram-image {
      image-rendering: auto;
    }
    .diagram-preload {
      display: none;
    }
    .source-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      background: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 12px;
      color: #5a5a5a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .source-header button {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: none;
    }
    .copy-status {
      font-size: 11px;
      color: #2f7a2f;
      opacity: 0;
      transition: opacity 0.2s ease;
      min-width: 70px;
      text-align: right;
    }
    .copy-status.visible {
      opacity: 1;
    }
    .copy-status.error {
      color: #b00020;
    }
    .source-content {
      flex: 1 1 auto;
      overflow: auto;
      padding: 16px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 12px;
      line-height: 1.5;
      background: #ffffff;
      color: #333;
      white-space: pre;
    }
  </style>
</head>
<body>

<div class="page">
  <div class="diagram-pane">
    <div class="diagram-wrap">
      <div class="diagram-toolbar">
        <button type="button" data-a="fit">Fit</button>
        <a href="${plantUmlPngUrl}" target="_blank" rel="noreferrer">Open PNG</a>
        <a href="${plantUmlSvgUrl}" target="_blank" rel="noreferrer" download>Download SVG</a>
        <button type="button" data-a="toggle-source" aria-expanded="true">Hide code</button>
      </div>
      <div class="diagram-scroll">
        <div id="diagramMap" class="diagram-map" data-image-url="${plantUmlPngUrl}" ${plantUmlPngDataAttributes}></div>
        <img id="plantImage" class="diagram-preload" src="${plantUmlPngUrl}" alt="PlantUML diagram" aria-hidden="true" ${plantUmlPngSizeAttributes}/>
      </div>
    </div>
  </div>
  <div class="source-pane">
    <div class="source-header"><span>PlantUML source</span><span class="copy-status" aria-live="polite" role="status"></span><button type="button" id="copyButton">Copy</button></div>
    <pre class="source-content" id="sourceContent">${plantUmlSource}</pre>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
  const page = document.querySelector('.page');
  const image = document.getElementById('plantImage');
  const mapContainer = document.getElementById('diagramMap');
  const sourcePane = document.querySelector('.source-pane');
  const toolbar = document.querySelector('.diagram-toolbar');
  const imageUrl = mapContainer ? mapContainer.getAttribute('data-image-url') : null;
  let map = null;
  let imageLayer = null;
  let imageBounds = null;
  let fitState = null;
  let layoutPending = false;
  const NATURAL_ZOOM = 0;

  function parsePositiveNumber(value) {
    if (!value) { return null; }
    const num = Number(value);
    return Number.isFinite(num) && num > 0 ? num : null;
  }

  function getNaturalWidth() {
    if (mapContainer) {
      const datasetWidth = parsePositiveNumber(mapContainer.getAttribute('data-natural-width'));
      if (datasetWidth) { return datasetWidth; }
    }
    if (image && image.naturalWidth > 0) {
      return image.naturalWidth;
    }
    return image ? parsePositiveNumber(image.getAttribute('width')) : null;
  }

  function getNaturalHeight() {
    if (mapContainer) {
      const datasetHeight = parsePositiveNumber(mapContainer.getAttribute('data-natural-height'));
      if (datasetHeight) { return datasetHeight; }
    }
    if (image && image.naturalHeight > 0) {
      return image.naturalHeight;
    }
    return image ? parsePositiveNumber(image.getAttribute('height')) : null;
  }

  function cacheNaturalSize() {
    if (!mapContainer || !image) { return; }
    const width = image.naturalWidth;
    const height = image.naturalHeight;
    if (width > 0 && height > 0) {
      const widthValue = String(width);
      const heightValue = String(height);
      mapContainer.setAttribute('data-natural-width', widthValue);
      mapContainer.setAttribute('data-natural-height', heightValue);
      image.setAttribute('width', widthValue);
      image.setAttribute('height', heightValue);
    }
  }

  function ensureMapReady() {
    if (!mapContainer || !window.L || !imageUrl) {
      return;
    }

    const naturalWidth = getNaturalWidth();
    const naturalHeight = getNaturalHeight();
    if (!naturalWidth || !naturalHeight) {
      return;
    }

    imageBounds = window.L.latLngBounds([[0, 0], [naturalHeight, naturalWidth]]);

    if (!map) {
      map = window.L.map(mapContainer, {
        crs: window.L.CRS.Simple,
        zoomControl: false,
        attributionControl: false,
        preferCanvas: true,
        wheelPxPerZoomLevel: 80,
        zoomSnap: 0.01,
        zoomDelta: 0.5,
        inertia: true
      });
    }

    if (imageLayer) {
      imageLayer.setBounds(imageBounds);
      imageLayer.setUrl(imageUrl);
    } else {
      imageLayer = window.L.imageOverlay(imageUrl, imageBounds, {
        interactive: true,
        className: 'diagram-image'
      }).addTo(map);
    }

    map.setMaxBounds(imageBounds);
    map.setView(imageBounds.getCenter(), NATURAL_ZOOM, { animate: false });
    scheduleLayoutRefresh();
  }

  function getViewportSize() {
    if (!mapContainer) { return null; }
    const rect = mapContainer.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    if (width > 0 && height > 0) {
      return { width: width, height: height };
    }
    const clientWidth = mapContainer.clientWidth;
    const clientHeight = mapContainer.clientHeight;
    if (clientWidth > 0 && clientHeight > 0) {
      return { width: clientWidth, height: clientHeight };
    }
    return null;
  }

  function recalcFitState() {
    if (!map || !imageBounds) {
      return;
    }

    const naturalWidth = getNaturalWidth();
    const naturalHeight = getNaturalHeight();
    const viewport = getViewportSize();
    if (!naturalWidth || !naturalHeight || !viewport) {
      return;
    }

    const scaleX = viewport.width / naturalWidth;
    const scaleY = viewport.height / naturalHeight;
    const fitScale = Math.min(scaleX, scaleY);
    if (!(fitScale > 0)) {
      return;
    }

    const fitZoom = NATURAL_ZOOM + Math.log2(fitScale);
    const center = imageBounds.getCenter();
    const minZoom = Math.min(fitZoom - 4, NATURAL_ZOOM - 4);
    const maxZoom = Math.max(NATURAL_ZOOM + 8, fitZoom + 8);

    map.setMinZoom(minZoom);
    map.setMaxZoom(maxZoom);

    fitState = {
      zoom: fitZoom,
      center: center
    };
  }

  function applyFit(animate) {
    if (!map || !fitState) { return; }
    map.setView(fitState.center, fitState.zoom, { animate: !!animate });
  }

  function refreshFit(animate, forceApply) {
    if (!map || !fitState) { return; }
    if (forceApply) {
      applyFit(animate);
      return;
    }
    const currentZoom = map.getZoom();
    const currentCenter = map.getCenter();
    const zoomMatches = typeof currentZoom === 'number' && Math.abs(currentZoom - fitState.zoom) < 0.01;
    const centerMatches = currentCenter
      ? (Math.abs(currentCenter.lat - fitState.center.lat) < 0.5 && Math.abs(currentCenter.lng - fitState.center.lng) < 0.5)
      : false;
    if (zoomMatches && centerMatches) {
      applyFit(animate);
    }
  }

  function scheduleLayoutRefresh() {
    if (!map || layoutPending) { return; }
    layoutPending = true;
    window.requestAnimationFrame(function () {
      map.invalidateSize();
      window.requestAnimationFrame(function () {
        layoutPending = false;
        recalcFitState();
        refreshFit(false, false);
      });
    });
  }

  function setSourceCollapsed(collapsed) {
    if (page) {
      page.classList.toggle('source-collapsed', collapsed);
    }
    if (sourcePane) {
      sourcePane.classList.toggle('collapsed', collapsed);
    }
    if (toolbar) {
      const toggle = toolbar.querySelector('[data-a="toggle-source"]');
      if (toggle) {
        toggle.textContent = collapsed ? 'Show code' : 'Hide code';
        toggle.setAttribute('aria-expanded', (!collapsed).toString());
      }
    }
  }

  setSourceCollapsed(false);

  if (toolbar) {
    toolbar.addEventListener('click', function (e) {
      const action = e.target && e.target.getAttribute('data-a');
      if (!action) { return; }
      e.preventDefault();
      if (action === 'fit') {
        refreshFit(true, true);
      } else if (action === 'toggle-source') {
        setSourceCollapsed(!page.classList.contains('source-collapsed'));
        setTimeout(function () {
          scheduleLayoutRefresh();
        }, 0);
      }
    });
  }

  function handleResize() {
    scheduleLayoutRefresh();
  }

  if (image) {
    image.addEventListener('load', function () {
      cacheNaturalSize();
      ensureMapReady();
    });

    if (image.complete) {
      cacheNaturalSize();
      ensureMapReady();
    }
  } else {
    ensureMapReady();
  }

  window.addEventListener('resize', handleResize);

  ensureMapReady();

  const copyButton = document.getElementById('copyButton');
  const sourceContent = document.getElementById('sourceContent');
  if (copyButton && sourceContent) {
    copyButton.addEventListener('click', function () {
      copyTextToClipboard(sourceContent.textContent || '').then(function (success) {
        showCopyFeedback(copyButton, success);
      });
    });
  }
})();

function copyTextToClipboard(text) {
  if (!text) { return Promise.resolve(false); }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text).then(function () {
      return true;
    }).catch(function () {
      return legacyCopy(text);
    });
  } else {
    return Promise.resolve(legacyCopy(text));
  }
}

function legacyCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.setAttribute('readonly', '');
  textarea.style.position = 'absolute';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  let success = false;
  try {
    success = document.execCommand('copy');
  } catch (err) {
    console.error('Failed to copy text', err);
    success = false;
  }
  document.body.removeChild(textarea);
  return success;
}

function showCopyFeedback(button, success) {
  if (!button) { return; }
  const header = button.closest('.source-header');
  if (!header) { return; }
  const status = header.querySelector('.copy-status');
  if (!status) { return; }

  status.textContent = success ? 'Copied!' : 'Copy failed';
  status.classList.toggle('error', !success);
  status.classList.add('visible');

  if (status._copyTimeout) {
    clearTimeout(status._copyTimeout);
  }
  status._copyTimeout = setTimeout(function () {
    status.classList.remove('visible');
  }, 2000);
}
</script>
</body>
</html>

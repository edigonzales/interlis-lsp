<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PlantUML class diagram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #ffffff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #333; }
    .page {
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: minmax(0, 2.5fr) minmax(280px, 1fr);
      gap: 16px;
    }
    .diagram-pane, .source-pane {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: #fafafa;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page.source-collapsed {
      grid-template-columns: minmax(0, 1fr);
    }
    .page.source-collapsed .source-pane {
      display: none;
    }
    .diagram-wrap {
      position: relative;
      flex: 1 1 auto;
      overflow: hidden;
    }
    .diagram-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      z-index: 2;
      display: flex;
      gap: 6px;
    }
    .diagram-toolbar button,
    .diagram-toolbar a {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    .diagram-scroll {
      position: absolute;
      inset: 0;
      overflow: hidden;
      cursor: grab;
      touch-action: none;
    }
    .diagram-scroll:active { cursor: grabbing; }
    .diagram-content {
      transform-origin: top left;
      display: inline-block;
      cursor: inherit;
    }
    .diagram-content img {
      display: block;
      cursor: inherit;
    }
    .source-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      background: rgba(255, 255, 255, 0.8);
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 12px;
      color: #5a5a5a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .source-header button {
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      text-transform: none;
    }
    .copy-status {
      font-size: 11px;
      color: #2f7a2f;
      opacity: 0;
      transition: opacity 0.2s ease;
      min-width: 70px;
      text-align: right;
    }
    .copy-status.visible {
      opacity: 1;
    }
    .copy-status.error {
      color: #b00020;
    }
    .source-content {
      flex: 1 1 auto;
      overflow: auto;
      padding: 16px;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 12px;
      line-height: 1.5;
      background: #ffffff;
      color: #333;
      white-space: pre;
    }
  </style>
</head>
<body>

<div class="page">
  <div class="diagram-pane">
    <div class="diagram-wrap">
      <div class="diagram-toolbar">
        <button type="button" data-a="fit">Fit</button>
        <a href="${plantUmlPngUrl}" target="_blank" rel="noreferrer">Open PNG</a>
        <a href="${plantUmlSvgUrl}" target="_blank" rel="noreferrer" download>Download SVG</a>
        <button type="button" data-a="toggle-source" aria-expanded="true">Hide code</button>
      </div>
      <div class="diagram-scroll">
        <div class="diagram-content" id="diagramContent" ${plantUmlPngDataAttributes}>
          <img id="plantImage" src="${plantUmlPngUrl}" alt="PlantUML diagram" ${plantUmlPngSizeAttributes}/>
        </div>
      </div>
    </div>
  </div>
  <div class="source-pane">
    <div class="source-header"><span>PlantUML source</span><span class="copy-status" aria-live="polite" role="status"></span><button type="button" id="copyButton">Copy</button></div>
    <pre class="source-content" id="sourceContent">${plantUmlSource}</pre>
  </div>
</div>

<script src="https://unpkg.com/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
<script>
(function() {
  const page = document.querySelector('.page');
  const content = document.getElementById('diagramContent');
  const image = document.getElementById('plantImage');
  const scroll = document.querySelector('.diagram-scroll');
  const sourcePane = document.querySelector('.source-pane');
  const toolbar = document.querySelector('.diagram-toolbar');
  const panzoom = content && scroll && window.Panzoom ? window.Panzoom(content, {
    maxScale: 8,
    minScale: 0.125,
    contain: 'none',
    cursor: 'grab',
    canvas: true
  }) : null;
  let fitState = null;

  function parsePositiveNumber(value) {
    if (!value) { return null; }
    const num = Number(value);
    return Number.isFinite(num) && num > 0 ? num : null;
  }

  function getNaturalWidth() {
    if (image && image.naturalWidth > 0) {
      return image.naturalWidth;
    }
    const contentWidth = content ? parsePositiveNumber(content.getAttribute('data-natural-width')) : null;
    if (contentWidth) { return contentWidth; }
    return image ? parsePositiveNumber(image.getAttribute('width')) : null;
  }

  function getNaturalHeight() {
    if (image && image.naturalHeight > 0) {
      return image.naturalHeight;
    }
    const contentHeight = content ? parsePositiveNumber(content.getAttribute('data-natural-height')) : null;
    if (contentHeight) { return contentHeight; }
    return image ? parsePositiveNumber(image.getAttribute('height')) : null;
  }

  function cacheNaturalSize() {
    if (!content || !image) { return; }
    const width = image.naturalWidth;
    const height = image.naturalHeight;
    if (width > 0 && height > 0) {
      const widthValue = String(width);
      const heightValue = String(height);
      content.setAttribute('data-natural-width', widthValue);
      content.setAttribute('data-natural-height', heightValue);
      image.setAttribute('width', widthValue);
      image.setAttribute('height', heightValue);
      if (content.style) {
        content.style.width = widthValue + 'px';
        content.style.height = heightValue + 'px';
      }
    }
  }

  function updateFitState() {
    if (!panzoom || !scroll) {
      return null;
    }

    const naturalWidth = getNaturalWidth();
    const naturalHeight = getNaturalHeight();
    if (!naturalWidth || !naturalHeight) {
      return null;
    }

    const { clientWidth, clientHeight } = scroll;
    if (!clientWidth || !clientHeight) {
      return null;
    }

    const fitScale = Math.min(clientWidth / naturalWidth, clientHeight / naturalHeight);
    const panX = (clientWidth - naturalWidth * fitScale) / 2;
    const panY = (clientHeight - naturalHeight * fitScale) / 2;
    const minScale = fitScale <= 0
      ? 0.02
      : Math.max(fitScale / 8, 0.02);
    const maxScale = Math.max(12, fitScale * 12);

    panzoom.setOptions({
      minScale: minScale,
      maxScale: maxScale,
      contain: 'none',
      cursor: 'grab',
      canvas: true
    });

    fitState = {
      scale: fitScale,
      x: panX,
      y: panY
    };

    return fitState;
  }

  function applyFit(animate) {
    if (!panzoom) { return; }
    const state = fitState || updateFitState();
    if (!state) { return; }
    panzoom.zoom(state.scale, { animate: !!animate, force: true, relative: false });
    panzoom.pan(state.x, state.y, { animate: !!animate, force: true, relative: false });
  }

  function refreshFit(animate) {
    updateFitState();
    applyFit(animate);
  }

  if (panzoom && scroll) {
    scroll.addEventListener('wheel', function (event) {
      event.preventDefault();
      panzoom.zoomWithWheel(event);
    }, { passive: false });
  }

  function setSourceCollapsed(collapsed) {
    if (page) {
      page.classList.toggle('source-collapsed', collapsed);
    }
    if (sourcePane) {
      sourcePane.classList.toggle('collapsed', collapsed);
    }
    if (toolbar) {
      const toggle = toolbar.querySelector('[data-a="toggle-source"]');
      if (toggle) {
        toggle.textContent = collapsed ? 'Show code' : 'Hide code';
        toggle.setAttribute('aria-expanded', (!collapsed).toString());
      }
    }
  }

  setSourceCollapsed(false);

  if (toolbar) {
    toolbar.addEventListener('click', function (e) {
      const action = e.target && e.target.getAttribute('data-a');
      if (!action) { return; }
      e.preventDefault();
      if (action === 'fit') {
        refreshFit(true);
      } else if (action === 'toggle-source') {
        setSourceCollapsed(!page.classList.contains('source-collapsed'));
        setTimeout(function () {
          refreshFit(false);
        }, 0);
      }
    });
  }

  function handleResize() {
    if (!panzoom) { return; }
    const currentScale = panzoom.getScale ? panzoom.getScale() : null;
    const wasFit = currentScale && fitState && Math.abs(currentScale - fitState.scale) < 0.01;
    updateFitState();
    if (wasFit) {
      applyFit(false);
    }
  }

  if (image) {
    image.addEventListener('load', function () {
      cacheNaturalSize();
      refreshFit(false);
    });

    if (image.complete) {
      cacheNaturalSize();
      refreshFit(false);
    }
  }

  window.addEventListener('resize', handleResize);

  const copyButton = document.getElementById('copyButton');
  const sourceContent = document.getElementById('sourceContent');
  if (copyButton && sourceContent) {
    copyButton.addEventListener('click', function () {
      copyTextToClipboard(sourceContent.textContent || '').then(function (success) {
        showCopyFeedback(copyButton, success);
      });
    });
  }
})();

function copyTextToClipboard(text) {
  if (!text) { return Promise.resolve(false); }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text).then(function () {
      return true;
    }).catch(function () {
      return legacyCopy(text);
    });
  } else {
    return Promise.resolve(legacyCopy(text));
  }
}

function legacyCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.setAttribute('readonly', '');
  textarea.style.position = 'absolute';
  textarea.style.left = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  let success = false;
  try {
    success = document.execCommand('copy');
  } catch (err) {
    console.error('Failed to copy text', err);
    success = false;
  }
  document.body.removeChild(textarea);
  return success;
}

function showCopyFeedback(button, success) {
  if (!button) { return; }
  const header = button.closest('.source-header');
  if (!header) { return; }
  const status = header.querySelector('.copy-status');
  if (!status) { return; }

  status.textContent = success ? 'Copied!' : 'Copy failed';
  status.classList.toggle('error', !success);
  status.classList.add('visible');

  if (status._copyTimeout) {
    clearTimeout(status._copyTimeout);
  }
  status._copyTimeout = setTimeout(function () {
    status.classList.remove('visible');
  }, 2000);
}
</script>
</body>
</html>
